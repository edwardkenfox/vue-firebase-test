<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Vue-firebase-test by edwardkenfox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Vue-firebase-test</h1>
      <h2 class="project-tagline">Demo application from the #love_swift camp</h2>
      <a href="https://github.com/edwardkenfox/vue-firebase-test" class="btn">View on GitHub</a>
      <a href="https://github.com/edwardkenfox/vue-firebase-test/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/edwardkenfox/vue-firebase-test/tarball/master" class="btn">Download .tar.gz</a>
    </section>
    <section class="main-content" id="app">
      <ul>
        <li class="message" v-for="message in messages">
          <span>{{ message.name }}: </span>
          <span>{{ message.text }}</span>
        </li>
      </ul>
      <input type="text" name="name" placeholder="Your name" v-model="name">
      <input type="text" name="text" placeholder="Message" v-model="text">
      <input type="submit" @click="sendMessage()">
      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/edwardkenfox/vue-firebase-test">Vue-firebase-test</a> is maintained by <a href="https://github.com/edwardkenfox">edwardkenfox</a>.</span>
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>
    </section>
    <script>
      app = new Vue({
        el: '#app',
        data: {
          messages: [],
          database: null,
          name: "",
          text: ""
        },
        watch: {
          messages: {
            deep: true,
            handler: function(_val, _oldval) {
              this.fetchMessages();
            }
          }
        },
        methods: {
          fetchMessages: function() {
            firebase.database().ref('/messages/').once('value')
            .then(function(messages) {
              return messages.val();
            })
            .then((json) => {
              if (json === null) throw new Error("No messages...");

              messages = app.messages = Object.keys(json).map(function (key) {
                return json[key];
              });
              return messages
            })
            .then((messages) => {
              this.messages = messages;
            })
            .catch(function(error) {
              console.warn(error)
            })
          },
          sendMessage: function() {
            if (this.name === "" || this.text === "") {
              alert("Input missing!");
              return false;
            }

            let postData = {
              name: this.name,
              text: this.text,
            };
            let newPostKey = firebase.database().ref().child('messages').push().key;
            let updates = {};
            updates['/messages/' + newPostKey] = postData;
            firebase.database().ref().update(updates);

            this.text = "";
          },
        },
        created: function() {
          config = {
            apiKey: "AIzaSyDtWwSVyo5Bakf4xpJTLbQxyrvyUrS-vbA",
            authDomain: "friendlychat-343cf.firebaseapp.com",
            databaseURL: "https://friendlychat-343cf.firebaseio.com/",
            storageBucket: "friendlychat-343cf",
          };
          firebase.initializeApp(config);
          this.database = firebase.database();
        },
        mounted: function() {
          this.fetchMessages();
        }
      })
    </script>
  </body>
</html>
